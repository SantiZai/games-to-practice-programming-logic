<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>Truco Argentino</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        margin: 0;
        display: grid;
        padding: 0;
        place-content: center;
        height: 100vh;
        font-family: Arial;
      }

      canvas {
        background: no-repeat center / cover url('assets/fondo.webp');
      }

      div {
        width: 100%;
        display: flex;
        justify-content: space-between;
      }

      span {
        font-size: 20px;
      }
    </style>

    <script type="module">
      const $canvas = document.querySelector('canvas');
      const context = canvas.getContext('2d');

      const canvasRect = $canvas.getBoundingClientRect();

      const $playerScore = document.querySelector('#player-score');
      const $botScore = document.querySelector('#bot-score');

      const $envidoButton = document.querySelector('#envido');
      const $trucoButton = document.querySelector('#truco');
      const $mazoButton = document.querySelector('#mazo');

      // CONSTANTS
      const PALOS = {
        ESPADA: 'espada',
        BASTO: 'basto',
        ORO: 'oro',
        COPA: 'copa',
      };
      // tuple(palo, numero, valor envido, valor de truco)
      const CARDS = [
        { '1E': [PALOS.ESPADA, 1, 11, 14] },
        { '1B': [PALOS.BASTO, 1, 11, 13] },
        { '7E': [PALOS.ESPADA, 7, 17, 12] },
        { '7O': [PALOS.ORO, 7, 17, 11] },
        { '3E': [PALOS.ESPADA, 3, 13, 10] },
        { '3B': [PALOS.BASTO, 3, 13, 10] },
        { '3O': [PALOS.ORO, 3, 13, 10] },
        { '3C': [PALOS.COPA, 3, 13, 10] },
        { '2E': [PALOS.ESPADA, 2, 12, 9] },
        { '2B': [PALOS.BASTO, 2, 12, 9] },
        { '2O': [PALOS.ORO, 2, 12, 9] },
        { '2C': [PALOS.COPA, 2, 12, 9] },
        { '1O': [PALOS.ORO, 1, 11, 8] },
        { '1C': [PALOS.COPA, 1, 11, 8] },
        { '12E': [PALOS.ESPADA, 12, 10, 7] },
        { '12B': [PALOS.BASTO, 12, 10, 7] },
        { '12O': [PALOS.ORO, 12, 10, 7] },
        { '12C': [PALOS.COPA, 12, 10, 7] },
        { '11E': [PALOS.ESPADA, 11, 10, 6] },
        { '11B': [PALOS.BASTO, 11, 10, 6] },
        { '11O': [PALOS.ORO, 11, 10, 6] },
        { '11C': [PALOS.COPA, 11, 10, 6] },
        { '10E': [PALOS.ESPADA, 10, 10, 5] },
        { '10B': [PALOS.BASTO, 10, 10, 5] },
        { '10O': [PALOS.ORO, 10, 10, 5] },
        { '10C': [PALOS.COPA, 10, 10, 5] },
        { '7B': [PALOS.BASTO, 7, 17, 4] },
        { '7C': [PALOS.COPA, 7, 17, 4] },
        { '6E': [PALOS.ESPADA, 6, 16, 3] },
        { '6B': [PALOS.BASTO, 6, 16, 3] },
        { '6O': [PALOS.ORO, 6, 16, 3] },
        { '6C': [PALOS.COPA, 6, 16, 3] },
        { '5E': [PALOS.ESPADA, 5, 15, 2] },
        { '5B': [PALOS.BASTO, 5, 15, 2] },
        { '5O': [PALOS.ORO, 5, 15, 2] },
        { '5C': [PALOS.COPA, 5, 15, 2] },
        { '4E': [PALOS.ESPADA, 4, 14, 1] },
        { '4B': [PALOS.BASTO, 4, 14, 1] },
        { '4O': [PALOS.ORO, 4, 14, 1] },
        { '4C': [PALOS.COPA, 4, 14, 1] },
      ];
      const MODES = {
        FIRST_HAND: 'first-hand',
        SECOND_HAND: 'second-hand',
        THIRD_HAND: 'third-hand',
        ADD_POINTS: 'add-points',
        GAME_OVER: 'game-over',
      };
      const MAX_SCORE = 15;
      const RESTRICTIONS = {
        NO_RESTRICTION: 'no-restriction',
        FIRST_HAND: MODES.FIRST_HAND,
      };
      const VALUES = {
        ENVIDO: {
          QUERIDO: 2,
          NO_QUERIDO: 1,
          RESTRICCION: RESTRICTIONS.FIRST_HAND,
        },
        TRUCO: {
          QUERIDO: 2,
          NO_QUERIDO: 1,
          RESTRICCION: RESTRICTIONS.NO_RESTRICTION,
        },
      };
      const HEIGHT_CARD = 80;
      const WIDTH_CARD = 60;

      // STATE
      let playerCardsPlayed = [];
      let botCardsPlayed = [];
      let cardsCurrentHand = [];
      let playerHand = [];
      let botHand = [];
      let mode,
        playerScore,
        botScore,
        envidoAccumulator,
        trucoAccumulator,
        winnerFirstHand,
        winnerSecondHand,
        winner,
        turn;

      function initializeGameState() {
        playerScore = 0;
        botScore = 0;
        envidoAccumulator = 0;
        trucoAccumulator = 0;
        winnerFirstHand = null;
        winnerSecondHand = null;
        winner = null;
        turn = Math.floor(Math.random() * 2) === 0 ? 'player' : 'bot';

        playerCardsPlayed = [];
        botCardsPlayed = [];
        cardsCurrentHand = [];
        mode = MODES.FIRST_HAND;

        mezclar();
      }

      function draw() {
        if (mode === MODES.GAME_OVER) return;

        // Limpia el canvas antes de redibujar
        context.clearRect(0, 0, canvas.width, canvas.height);

        // Redibuja las cartas
        drawPlayerCards(playerHand);
        drawBotCards(botHand);

        $playerScore.innerText = playerScore;
        $botScore.innerText = botScore;

        window.requestAnimationFrame(draw);
      }

      function restart() {
        initializeGameState();
        draw();
        play();
      }

      $envidoButton.addEventListener('click', () => {
        envidoAccumulator++;

        const envidoQuerido = Math.floor(Math.random() * 2) === 1;

        if (envidoQuerido) {
          envidoAccumulator++;
          const ganador = compararTantos();
          if (ganador === 'player') {
            playerScore += envidoAccumulator;
          } else if (ganador === 'bot') {
            botScore += envidoAccumulator;
          }
        } else {
          playerScore += envidoAccumulator;
        }

        $envidoButton.disabled = true;
      });

      function compararTantos() {
        //TODO comparar tantos
        //TODO hacer logica si hay empate de tantos
      }

      function play() {
        if (mode === MODES.GAME_OVER) return

        if (
          (mode === MODES.FIRST_HAND &&
            playerCardsPlayed.length === 1 &&
            botCardsPlayed.length === 1) ||
          (mode === MODES.SECOND_HAND &&
            playerCardsPlayed.length === 2 &&
            botCardsPlayed.length === 2) ||
          (mode === MODES.THIRD_HAND &&
            playerCardsPlayed.length === 3 &&
            botCardsPlayed.length === 3)
        ) {
          const handWinner = verifyHandWinner();

          if (handWinner === 'parda') {
            if (mode != MODES.FIRST_HAND) {
              if (winnerFirstHand != null) {
                winner = winnerFirstHand;
              } else {
                winner = winnerSecondHand;
              }
            }
          }

          if (mode === MODES.FIRST_HAND) {
            winnerFirstHand = handWinner;
          } else if (mode === MODES.SECOND_HAND) {
            winnerSecondHand = handWinner;
          } else {
            winner = handWinner;
          }

          const newTurn = handWinner === 'player' ? 'player' : 'bot';
          turn = newTurn;

          verifyWinner();

          if (winner == null) siguienteMano();
        }

        if (turn === 'player') {
          document.addEventListener('click', handlePlayerClick);
        } else {
          playBotTurn();
        }
      }

      function playBotTurn() {
        const jugadaBot = Math.floor(Math.random() * botHand.length);

        const cartaJugadaBot = botHand[jugadaBot];

        botCardsPlayed.push(cartaJugadaBot);
        botHand.splice(jugadaBot, 1);

        turn = 'player';

        drawBotCards(botHand);

        play();
      }

      function handlePlayerClick(event) {
        const { clientX, clientY } = event;
        const xWithinCanvas = clientX - canvasRect.left;
        const yWithinCanvas = clientY - canvasRect.top;

        const clickedCardIndex = playerHand.findIndex((card, index) => {
          const cardX = card.x;
          const cardY = card.y - HEIGHT_CARD;
          const cardWidth = WIDTH_CARD;
          const cardHeight = HEIGHT_CARD;

          return (
            xWithinCanvas >= cardX &&
            xWithinCanvas <= cardX + cardWidth &&
            yWithinCanvas >= cardY &&
            yWithinCanvas <= cardY + cardHeight
          );
        });

        if (clickedCardIndex !== -1) {
          playPlayerTurn(clickedCardIndex);
        }
      }

      function playPlayerTurn(index) {
        const cartaJugadaPlayer = playerHand[index];

        playerCardsPlayed.push(cartaJugadaPlayer);
        playerHand.splice(index, 1);

        turn = 'bot';

        drawPlayerCards(playerHand);

        play();
      }

      function verifyHandWinner() {
        const playerPlayed = Object.values(
          playerCardsPlayed[playerCardsPlayed.length - 1]
        )[0];
        const botPlayed = Object.values(
          botCardsPlayed[botCardsPlayed.length - 1]
        )[0];

        const valorTrucoPlayer = playerPlayed[3];
        const valorTrucoBot = botPlayed[3];

        if (valorTrucoPlayer > valorTrucoBot) {
          return 'player';
        } else if (valorTrucoBot > valorTrucoPlayer) {
          return 'bot';
        } else {
          return 'parda';
        }
      }

      function verifyWinner() {
        if (mode !== MODES.FIRST_HAND && winnerFirstHand === winnerSecondHand) {
          winner = winnerFirstHand;
          mode = MODES.ADD_POINTS;
        } else if (
          playerCardsPlayed.length === 3 &&
          botCardsPlayed.length === 3
        ) {
          const winnerHand = verifyHandWinner();
          if (winnerHand === 'parda') {
            winner = winnerFirstHand;
          } else {
            winner = winnerHand;
          }
          mode = MODES.ADD_POINTS;
        }
        if (winner != null) addPoints();
      }

      function addPoints() {
        context.clearRect(0, 0, canvas.width, canvas.height)
        drawCards()
        //TODO agregar puntos
        winner === 'player'
          ? ($playerScore.innerText = 2)
          : ($botScore.innerText = 2);
        mode = MODES.GAME_OVER
      }

      function siguienteMano() {
        switch (mode) {
          case MODES.FIRST_HAND:
            mode = MODES.SECOND_HAND;
            break;
          case MODES.SECOND_HAND:
            mode = MODES.THIRD_HAND;
            break;
          case MODES.THIRD_HAND:
            mode = MODES.ADD_POINTS;
            break;
          case MODES.ADD_POINTS:
            mode = MODES.GAME_OVER;
            break;
        }
      }

      function drawCards() {
        drawPlayerCards(playerHand);
        drawBotCards(botHand);
      }

      function drawPlayerCards(hand) {
        hand.forEach((card) => {
          context.fillStyle = 'white';
          context.fillRect(
            card.x,
            card.y - HEIGHT_CARD,
            WIDTH_CARD,
            HEIGHT_CARD
          );

          context.fillStyle = 'black';
          context.font = '16px Arial';
          context.fillText(
            `${Object.values(card)[0][1]} ${Object.values(card)[0][0]}`,
            card.x,
            card.y - HEIGHT_CARD / 2 + 8
          );
        });

        playerCardsPlayed.forEach((card) => {
          context.fillStyle = 'gray';
          context.fillRect(
            card.x,
            card.y - HEIGHT_CARD * 2,
            WIDTH_CARD,
            HEIGHT_CARD
          );

          context.fillStyle = 'black';
          context.font = '16px Arial';
          context.fillText(
            `${Object.values(card)[0][1]} ${Object.values(card)[0][0]}`,
            card.x,
            card.y - HEIGHT_CARD * 2 + HEIGHT_CARD / 2
          );
        });
      }

      function drawBotCards(hand) {
        hand.forEach((card) => {
          context.fillStyle = 'white';
          context.fillRect(card.x, card.y, WIDTH_CARD, HEIGHT_CARD);

          context.fillStyle = 'black';
          context.font = '16px Arial';
          context.fillText(
            `${Object.values(card)[0][1]}${Object.values(card)[0][0]}`,
            card.x,
            card.y + HEIGHT_CARD / 2 + 8
          );
        });

        botCardsPlayed.forEach((card) => {
          context.fillStyle = 'gray';
          context.fillRect(
            card.x,
            card.y + HEIGHT_CARD,
            WIDTH_CARD,
            HEIGHT_CARD
          );

          context.fillStyle = 'black';
          context.font = '16px Arial';
          context.fillText(
            `${Object.values(card)[0][1]} ${Object.values(card)[0][0]}`,
            card.x,
            card.y + HEIGHT_CARD * 2 - HEIGHT_CARD / 2
          );
        });
      }

      function mezclar() {
        for (let i = 0; i < 6; i++) {
          const random = Math.floor(Math.random() * CARDS.length);

          const cardGenerated = CARDS[random];

          if (playerHand.length === 3) {
            botHand.push({
              ...cardGenerated,
              x: canvas.width / 2 - WIDTH_CARD * (i - 4),
              y: 100,
            });
            cardsCurrentHand.push({
              ...cardGenerated,
              x: canvas.width / 2 - WIDTH_CARD * (i + 4),
              y: 100,
            });
          } else {
            playerHand.push({
              ...cardGenerated,
              x: canvas.width / 2 - WIDTH_CARD * i,
              y: 400,
            });
            cardsCurrentHand.push({
              ...cardGenerated,
              x: canvas.width / 2 - WIDTH_CARD * i,
              y: 400,
            });
          }
        }
      }

      restart();
    </script>
  </head>
  <body>
    <div>
      <span>Jugador: <span id="player-score">0</span></span>
      <span>Bot: <span id="bot-score">0</span></span>
    </div>
    <canvas
      id="canvas"
      height="500"
      width="500"
    ></canvas>
    <div class="container-cantos">
      <button id="envido">Envido</button>
      <button id="truco">Truco</button>
      <button id="mazo">Me voy al mazo</button>
    </div>
  </body>
</html>
